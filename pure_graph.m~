clear all
clc
close all
delete(instrfindall);
%Delete previous connections
%delete(instrfind({'Port'},{'/dev/tty.usbserial-A900abKE'}));
%Create a serial connection
s = serial('/dev/tty.usbserial-A900abKE','BaudRate',115200,'Terminator','CR/LF');
warning('off','MATLAB:serial:fscanf:unsuccessfulRead');
%Open Port


set(s,'BaudRate', 115200);
set(s,'DataBits', 8);
set(s,'StopBits', 1);
fopen(s);
s.ReadAsyncMode = 'continuous';
wait(


readasync(s);

%Initialize the variables
Nvalues=50; %Number of values ??we want to read
m1=zeros(1,Nvalues);

i=1;
k=1;
tic;
starttime = tic;



s_data = zeros(Nvalues,3);

while k<Nvalues
    %Read the serial port
    m1 = fscanf(s, '%d');
    
    if (m1 == 999999 )
        s_data(k,1) = fscanf(s, '%d');
        s_data(k,2) = fscanf(s, '%d');
        s_data(k,3) = fscanf(s, '%d');
        k=k+1;
        disp(k);
    else
        fprintf('wrong line - %d\n',m1);
    end
    
    
    %subplot(4,1,1); %plot the raw input
    %plot(m1);
    %axis([0 Nvalues 94000 105000])
    
    %     i=i+1;
    %   k=k+1;
end
fclose(s);
delete(s);
elapsed_time = toc(starttime);
s_min = 0;
s_max = 0;

figure(1);
for x = 1: Nvalues
    for y = 1:3
        if s_data(y) <150000 && s_data(y)> 50000
            if (s_data(y)>s_max)
                s_max = s(y);
            end
            if (s_data(y)<s_min)
                s_min = s(y);
            end
        end
    end
end


plot(s,'DisplayName','s0','YDataSource','s(1)');hold all;plot(s0,'DisplayName','s1','YDataSource','s(2)');plot(s1,'DisplayName','s2','YDataSource','s(3)');hold off;figure(gcf);
xlabel('Time [# Datapoints]');
ylabel('Pressure [Pa]');
axis([0 Nvalues s_min s_max]);
fprintf('We read %d datapoints in %f seconds\n',Nvalues, elapsed_time);
fprintf('The update rate is thus %f Hz\n',Nvalues/elapsed_time);
%axis([0 Nvalues min(m1)-200 max(m1)+200]);

